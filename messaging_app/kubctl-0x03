#!/bin/bash

# kubctl-0x03 - Rolling Update Script
# Task 5: Applying rolling updates

echo "ğŸ”„ Starting rolling update for Django messaging app..."

# Apply the updated deployment file (triggers rolling update)
echo "ğŸ“ Applying updated blue_deployment.yaml with v2.0..."
kubectl apply -f blue_deployment.yaml

echo ""
echo "â³ Monitoring rolling update progress..."

# Monitor the rollout status
kubectl rollout status deployment/django-messaging-app-blue --timeout=300s

echo ""
echo "ğŸ§ª Testing app availability during update..."

# Start continuous testing in background
echo "Starting continuous availability test..."

# Port forward for testing
kubectl port-forward service/django-messaging-service-blue 8001:8000 &
PORT_FORWARD_PID=$!

# Wait for port forward to establish
sleep 5

# Continuous testing function
test_availability() {
    echo "ğŸ” Testing app availability (30 requests over 30 seconds)..."
    success_count=0
    total_requests=30
    
    for i in $(seq 1 $total_requests); do
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/ 2>/dev/null)
        if [ "$response" = "200" ]; then
            echo "âœ… Request $i: Success ($response)"
            ((success_count++))
        else
            echo "âŒ Request $i: Failed ($response)"
        fi
        sleep 1
    done
    
    echo ""
    echo "ğŸ“Š Availability Test Results:"
    echo "   Successful requests: $success_count/$total_requests"
    echo "   Success rate: $((success_count * 100 / total_requests))%"
}

# Run availability test
test_availability

# Clean up port forward
kill $PORT_FORWARD_PID 2>/dev/null

echo ""
echo "ğŸ” Verifying rolling update completion..."

# Check current pods
echo "Current pods:"
kubectl get pods -l app=django-messaging-app,version=blue

echo ""
echo "ğŸ“‹ Deployment status:"
kubectl get deployment django-messaging-app-blue

echo ""
echo "ğŸ“ Rollout history:"
kubectl rollout history deployment/django-messaging-app-blue

echo ""
echo "ğŸ” Checking pod image versions:"
kubectl get pods -l app=django-messaging-app,version=blue -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[0].image}{"\n"}{end}'

echo ""
echo "âœ… Rolling update complete!"
echo "ğŸ“Š Use 'kubectl describe deployment django-messaging-app-blue' for detailed status"